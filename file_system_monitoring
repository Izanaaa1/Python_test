import config as cfg
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
import time

class Watcher(FileSystemEventHandler):
    def __init__(self):
        self.changes = []
    
    def send_email_notification(self, change_description):
        """Отправляет уведомление на почту об изменении"""
        try:
            msg = MIMEMultipart()
            to_email = cfg.TO_EMAIL  # Получатель из config
            
            msg['Subject'] = f"Файловые изменения: {change_description[:50]}..."  
            msg['From'] = cfg.MAIL
            msg['To'] = to_email

            msg_body = f"Обнаружено изменение в файловой системе:\n\n{change_description}\n\nВремя обнаружения: {time.strftime('%Y-%m-%d %H:%M:%S')}"
            msg.attach(MIMEText(msg_body, 'plain'))

            server = smtplib.SMTP_SSL('smtp.gmail.com: 465')
            server.login(cfg.MAIL, cfg.PASSWORD)
            server.sendmail(cfg.MAIL, to_email, msg.as_string())
            server.quit()
            
            print(f"Уведомление отправлено: {change_description}")
            
        except Exception as e:
            print(f"Ошибка при отправке email: {e}")

    def on_modified(self, event):
        if event.is_directory:
            return
        
        change_description = f"Изменен файл: {event.src_path}"
        print(change_description)
        self.send_email_notification(change_description)

    def on_created(self, event):
        if event.is_directory:
            return
        
        change_description = f"Создан файл: {event.src_path}"
        print(change_description)
        self.send_email_notification(change_description)

    def on_deleted(self, event):
        if event.is_directory:
            return
        
        change_description = f"Удален файл: {event.src_path}"
        print(change_description)
        self.send_email_notification(change_description)

    def on_moved(self, event):
        if event.is_directory:
            return
        
        change_description = f"Файл перемещен: {event.src_path} -> {event.dest_path}"
        print(change_description)
        self.send_email_notification(change_description)

# Создаем и запускаем наблюдатель
event_handler = Watcher()
observer = Observer()
observer.schedule(event_handler, path="/home/igrami/Загрузки", recursive=True)

print("Мониторинг файловой системы запущен...")
observer.start()

try:
    while True:
        time.sleep(1)
except KeyboardInterrupt:
    observer.stop()
    print("Мониторинг остановлен")



if __name__ == '__main__':
    observer.join()